<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forestry AI Lab | Interactive Course Companion</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Three.js for 3D LiDAR Simulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        canvas { touch-action: none; }
        .slider-thumb::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #166534; border-radius: 50%; cursor: pointer; }
        /* Custom scrollbar for log output */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        
        /* Fire Animation */
        @keyframes burn {
            0% { background-color: #fca5a5; }
            50% { background-color: #ef4444; }
            100% { background-color: #b91c1c; }
        }
        .burning { animation: burn 0.5s infinite alternate; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- ICONS ---
        const IconTree = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"/><path d="M15 2H9a1 1 0 0 0-1 1v2c0 .28-.22.5-.5.5l-3 3 5 5 1 1 1-1 5-5-3-3c-.28 0-.5-.22-.5-.5V3a1 1 0 0 0-1-1z"/><path d="M10.2 17h3.6a2 2 0 0 1 1.9 2 1 1 0 0 0 1 1h0a1 1 0 0 0 1-1 2 2 0 0 1 1.9-2h.9a1 1 0 0 1 1 1v2a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2v-2a1 1 0 0 1 1-1z"/></svg>;
        const IconEye = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconFire = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3Z"/></svg>;
        const IconScan = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>;
        const IconDatabase = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const IconBook = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const IconX = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const IconShovel = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 22v-5l5-5 5 5-5 5z"/><path d="M9.5 14.5 16 8"/><path d="m17 2 5 5-.5.5a3.53 3.53 0 0 1-5 0s0 0 0 0a3.53 3.53 0 0 1 0-5L17 2z"/></svg>;

        // --- CONTENT: Module 1 Guide ---
        const VisionGuideContent = () => (
            <div className="p-8 prose prose-green max-w-none text-gray-700">
                <div className="bg-green-50 border-l-4 border-green-600 p-4 mb-6">
                    <strong className="block text-green-800 mb-1">Objective</strong>
                    Calibrate an AI model to count timber logs while avoiding "False Positives" (rocks/debris).
                </div>

                <h3 className="font-bold text-lg text-gray-900 mt-6">Part 1: The Concept</h3>
                <p>
                    <strong>Computer Vision</strong> is the science of teaching a computer to "see." Unlike a human, a computer sees a log as a grid of numbers (pixel colors).
                </p>
                <p>
                    When an AI analyzes an image (like a drone photo of a cut block), it doesn't say <em>"That is a log."</em> It says: <em>"I am <strong>85% confident</strong> that this cluster of brown pixels is a log."</em>
                </p>
                <p>
                    As the forester, <strong>YOU</strong> decide the cut-off point. This is called the <strong>Confidence Threshold</strong>.
                </p>

                <div className="mt-6 bg-blue-50 p-5 rounded-lg border border-blue-100">
                    <h4 className="font-bold text-blue-900 mb-3 text-base flex items-center gap-2">
                        <IconEye className="w-4 h-4"/> Real-World Forestry Applications
                    </h4>
                    <ul className="list-disc pl-5 space-y-2 text-sm text-blue-800">
                        <li>
                            <strong>Digital Log Scaling:</strong> Mobile apps (e.g., Timbeter) use computer vision to detect log ends in a pile, automatically calculating volume, pile density, and diameter distributions in seconds.
                        </li>
                        <li>
                            <strong>Precision Inventory (Census):</strong> Instead of sampling 5% of a stand, drones capture the entire area. AI algorithms count every single individual tree (100% census) and measure canopy height from the imagery.
                        </li>
                        <li>
                            <strong>Early Pest Detection:</strong> AI analyzes multispectral satellite imagery to detect subtle color shifts in foliage (stress signals) caused by Bark Beetles or root rot <em>before</em> the trees turn red to the human eye.
                        </li>
                        <li>
                            <strong>Wildlife Monitoring:</strong> Machine learning models process millions of hours of camera trap footage to automatically identify and count species, filtering out "empty" videos triggered by wind.
                        </li>
                    </ul>
                </div>

                <hr className="my-6 border-gray-200"/>

                <h3 className="font-bold text-lg text-gray-900">Part 2: The Simulation</h3>
                <p>In this lab, the <strong>Brown Circles</strong> are Merchantable Timber, and the <strong>Grey Shapes</strong> are Rocks/Debris.</p>

                <div className="space-y-6 mt-4">
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="font-bold text-green-800">Experiment A: The "Greedy" AI</h4>
                        <p className="text-sm mb-2 italic">Set the AI Confidence Slider to <strong>10%</strong>.</p>
                        <ul className="list-disc pl-5 space-y-1 text-sm">
                            <li>Does it miss any logs?</li>
                            <li>Does it count rocks?</li>
                            <li><strong>Impact:</strong> If you used this setting to pay a logger, what would happen?</li>
                        </ul>
                    </div>

                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="font-bold text-green-800">Experiment B: The "Cautious" AI</h4>
                        <p className="text-sm mb-2 italic">Set the AI Confidence Slider to <strong>90%</strong>.</p>
                        <ul className="list-disc pl-5 space-y-1 text-sm">
                            <li>Does it find all the logs?</li>
                            <li><strong>Impact:</strong> If you used this setting to calculate inventory value, what would happen?</li>
                        </ul>
                    </div>

                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="font-bold text-green-800">Experiment C: Calibration</h4>
                        <p className="text-sm mb-2 italic">Adjust the slider until you find the perfect balance.</p>
                        <ul className="list-disc pl-5 space-y-1 text-sm">
                            <li>Target: Get False Positives to 0 while keeping "AI Found" close to "Actual Logs".</li>
                            <li>What was your optimal threshold %?</li>
                        </ul>
                    </div>
                </div>

                <hr className="my-6 border-gray-200"/>

                <h3 className="font-bold text-lg text-gray-900">Part 3: Critical Thinking</h3>
                <ul className="list-decimal pl-5 space-y-4">
                    <li>
                        <strong>Question 1:</strong> In a real forestry scenario, which error is worse?
                        <div className="mt-1 ml-4 text-sm bg-white p-2 border rounded">A) Over-estimating volume vs. B) Under-estimating volume</div>
                    </li>
                    <li>
                        <strong>Question 2:</strong> Why did the AI struggle with some of the "Logs" in the simulation? (Hint: Look at the color/texture).
                    </li>
                    <li>
                        <strong>Question 3:</strong> If you were flying a drone survey on a <strong>cloudy day</strong> versus a <strong>sunny day</strong>, would you need to change your threshold? Why?
                    </li>
                </ul>

                <div className="mt-8">
                    <details className="group border border-blue-200 rounded-lg bg-blue-50 open:bg-blue-50 transition-colors">
                        <summary className="cursor-pointer p-4 font-bold text-blue-800 flex items-center gap-2 select-none">
                            <span>Instructor Answer Key</span>
                            <span className="text-xs font-normal text-blue-600">(Click to Reveal)</span>
                        </summary>
                        <div className="p-4 pt-0 text-sm text-blue-900 space-y-2">
                            <p><strong>Experiment A:</strong> High Recall, Low Precision. Result: Overpaying loggers, counting rocks as wood.</p>
                            <p><strong>Experiment B:</strong> High Precision, Low Recall. Result: Undervaluing the stand.</p>
                            <p><strong>Q1:</strong> Usually <strong>A (Over-estimating)</strong> is worse for liability, but B is bad for profit.</p>
                            <p><strong>Q2:</strong> The AI assigns a "Score" based on pixel similarity. "Dirty" logs have lower scores.</p>
                            <p><strong>Q3:</strong> Yes. Lighting changes pixel values. Calibration is essential every flight.</p>
                        </div>
                    </details>
                </div>
            </div>
        );

        // --- CONTENT: Module 2 Guide (Prediction) ---
        const PredictionGuideContent = () => (
            <div className="p-8 prose prose-green max-w-none text-gray-700">
                <div className="bg-red-50 border-l-4 border-red-600 p-4 mb-6">
                    <strong className="block text-red-800 mb-1">Objective</strong>
                    Use variables (Fuel, Wind, Slope) to predict future outcomes and mitigate risk.
                </div>

                <h3 className="font-bold text-lg text-gray-900 mt-6">Part 1: The Digital Crystal Ball</h3>
                <p>
                    <strong>Predictive Analytics</strong> is the use of historical data to estimate future events. In forestry, we don't have a crystal ball, but we have math.
                </p>
                <p>
                    By feeding an AI model thousands of past events (e.g., "On days with 15% humidity and 20km/h wind, fire spread 500m/hour"), the system learns patterns that are invisible to humans.
                </p>

                <div className="mt-6 bg-blue-50 p-5 rounded-lg border border-blue-100">
                    <h4 className="font-bold text-blue-900 mb-3 text-base flex items-center gap-2">
                        <IconDatabase className="w-4 h-4"/> Real-World Forestry Applications
                    </h4>
                    <ul className="list-disc pl-5 space-y-2 text-sm text-blue-800">
                        <li>
                            <strong>Fire Behaviour Prediction:</strong> Tools like <em>FARSITE</em> or <em>Prometheus</em> use the same logic as this simulator. They ingest weather data, topography, and fuel types to generate "Burn Probability Maps" for the next 24 hours.
                        </li>
                        <li>
                            <strong>Growth & Yield Modeling:</strong> Models like <em>FVS (Forest Vegetation Simulator)</em> or <em>TASS</em> predict how a stand will grow over 50 years. "If I thin this stand to 800 stems/ha today, what will the merchantable volume be in 2045?"
                        </li>
                        <li>
                            <strong>Harvest Optimization:</strong> Mills use predictive models to match log supply with market demand. "Based on housing starts, we predict a shortage of 2x4s next month; prioritize harvesting Block A."
                        </li>
                    </ul>
                </div>

                <hr className="my-6 border-gray-200"/>

                <h3 className="font-bold text-lg text-gray-900">Part 2: The Simulation Logic</h3>
                <p>This simulation runs a <strong>Cellular Automaton</strong>. It is not magic; it is a set of simple rules run thousands of times.</p>
                
                <div className="bg-gray-100 p-4 rounded-lg text-sm font-mono mb-4 border border-gray-300">
                    <strong>Logic Loop:</strong><br/>
                    1. Am I burning?<br/>
                    2. Check my North neighbor.<br/>
                    3. Is the wind blowing North? (Increase Probability)<br/>
                    4. Is the neighbor Grass or Timber? (Modify Probability)<br/>
                    5. Roll the dice. If random number &lt; Probability, ignite neighbor.
                </div>

                <h4 className="font-bold text-red-800 mt-6">Experiment A: Fuel Types</h4>
                <p className="text-sm mb-2">Reset the map until you get a mix of Grass (Light Green) and Timber (Dark Green). Ignite the Grass.</p>
                <ul className="list-disc pl-5 space-y-1 text-sm">
                    <li>Does the fire move faster in Grass or Timber?</li>
                    <li>Why is "Flashy Fuel" (Grass) dangerous for initial attack crews?</li>
                </ul>

                <h4 className="font-bold text-red-800 mt-4">Experiment B: The Wind Factor</h4>
                <p className="text-sm mb-2">Set <strong>Wind Speed to 10</strong> (Max) and direction to <strong>East</strong>.</p>
                <ul className="list-disc pl-5 space-y-1 text-sm">
                    <li>Watch the shape of the fire. It should form a narrow "Cigar" or "Flank" shape.</li>
                    <li>Now set <strong>Wind Speed to 0</strong>. The fire should grow in a circle.</li>
                </ul>

                <h4 className="font-bold text-red-800 mt-4">Experiment C: Containment Challenge</h4>
                <p className="text-sm mb-2"><strong>Goal:</strong> Stop the fire before it burns 50% of the map.</p>
                <ul className="list-disc pl-5 space-y-1 text-sm">
                    <li>Start the fire.</li>
                    <li>Pause the simulation (optional).</li>
                    <li>Use the <strong>Dozer Line</strong> tool to dig a break ahead of the fire front.</li>
                    <li>Resume. Did the fire jump your line? (If wind is high, it might!).</li>
                </ul>

                <hr className="my-6 border-gray-200"/>

                <h3 className="font-bold text-lg text-gray-900">Part 3: Critical Thinking</h3>
                <p className="italic text-gray-600 mb-4">"All models are wrong, but some are useful." - George Box</p>
                <ul className="list-decimal pl-5 space-y-4">
                    <li>
                        <strong>Question 1:</strong> Why might a fire prediction model fail in real life? What variables are missing from this simple simulation? (e.g., Spotting/Embers, detailed topography).
                    </li>
                    <li>
                        <strong>Question 2:</strong> If an AI predicts a low fire risk, but you walk outside and feel hot dry wind, which data source do you trust? The AI or your skin?
                    </li>
                </ul>
            </div>
        );

        // --- MODULE 0: INTRODUCTION (HOME) ---
        const IntroLab = ({ setTab }) => (
            <div className="space-y-8 animate-fade-in">
                <div className="bg-white p-8 rounded-xl shadow-lg border-l-8 border-green-700">
                    <h2 className="text-3xl font-bold mb-4 text-green-900">Welcome to AI-Enhanced Forestry</h2>
                    <p className="text-xl text-gray-700 mb-6 leading-relaxed">
                        This interactive lab is designed for professional foresters. Our goal is not to make you a programmer, 
                        but to make you an <strong>Informed Operator</strong>.
                    </p>
                    <p className="text-gray-600 italic border-l-4 border-gray-300 pl-4 py-2 bg-gray-50 rounded-r">
                        "Just as you don't need to know how to build a chainsaw engine to fell a tree, you don't need to write code to use AI. 
                        However, you <strong>do</strong> need to know when the tool is dull, broken, or dangerous."
                    </p>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow">
                        <div className="flex items-center gap-3 mb-3">
                            <div className="p-2 bg-blue-100 rounded-lg text-blue-700"><IconDatabase /></div>
                            <h3 className="font-bold text-xl text-gray-800">The Big Shift</h3>
                        </div>
                        <p className="text-gray-600 leading-relaxed">
                            For 100 years, forestry has relied on <strong>Sampling</strong> (measuring 5% of a stand to guess the rest). 
                            AI enables a <strong>Census</strong> approachâ€”measuring every single tree using sensors (LiDAR, Drone) and algorithms.
                        </p>
                    </div>
                    
                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow">
                        <div className="flex items-center gap-3 mb-3">
                            <div className="p-2 bg-yellow-100 rounded-lg text-yellow-700"><IconEye /></div>
                            <h3 className="font-bold text-xl text-gray-800">Human in the Loop</h3>
                        </div>
                        <p className="text-gray-600 leading-relaxed">
                            AI is a "Decision Support Tool," not a decision maker. It can calculate volume in seconds, but it cannot judge ethics or context. 
                            Throughout these labs, watch for errors and "hallucinations." <strong>You are the safety net.</strong>
                        </p>
                    </div>
                </div>

                <div>
                    <h3 className="font-bold text-2xl mb-4 text-gray-800 border-b pb-2">Course Modules</h3>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onClick={() => setTab(1)} className="group p-5 bg-white hover:bg-green-50 rounded-xl border border-gray-200 hover:border-green-300 text-left transition-all shadow-sm hover:shadow-md">
                            <div className="font-bold text-green-800 flex items-center gap-2 text-lg group-hover:text-green-900">
                                <IconEye className="w-5 h-5"/> 1. Computer Vision
                            </div>
                            <div className="text-sm text-gray-600 mt-2">
                                Learn how AI "sees" the forest. Simulate a log scaling app and understand confidence thresholds.
                            </div>
                        </button>

                        <button onClick={() => setTab(2)} className="group p-5 bg-white hover:bg-red-50 rounded-xl border border-gray-200 hover:border-red-300 text-left transition-all shadow-sm hover:shadow-md">
                            <div className="font-bold text-red-800 flex items-center gap-2 text-lg group-hover:text-red-900">
                                <IconFire className="w-5 h-5"/> 2. Prediction
                            </div>
                            <div className="text-sm text-gray-600 mt-2">
                                Use historical data to predict the future. Simulate fire spread variables like wind and slope.
                            </div>
                        </button>

                        <button onClick={() => setTab(3)} className="group p-5 bg-white hover:bg-blue-50 rounded-xl border border-gray-200 hover:border-blue-300 text-left transition-all shadow-sm hover:shadow-md">
                            <div className="font-bold text-blue-800 flex items-center gap-2 text-lg group-hover:text-blue-900">
                                <IconScan className="w-5 h-5"/> 3. Generative AI
                            </div>
                            <div className="text-sm text-gray-600 mt-2">
                                The "Digital Clerk." Generate professional reports but learn to catch AI "hallucinations."
                            </div>
                        </button>

                        <button onClick={() => setTab(4)} className="group p-5 bg-white hover:bg-yellow-50 rounded-xl border border-gray-200 hover:border-yellow-300 text-left transition-all shadow-sm hover:shadow-md">
                            <div className="font-bold text-yellow-800 flex items-center gap-2 text-lg group-hover:text-yellow-900">
                                <IconDatabase className="w-5 h-5"/> 4. Data Quality
                            </div>
                            <div className="text-sm text-gray-600 mt-2">
                                "Garbage In, Garbage Out." Train a model yourself and see why bad data ruins results.
                            </div>
                        </button>

                        <button onClick={() => setTab(5)} className="group p-5 bg-white hover:bg-purple-50 rounded-xl border border-gray-200 hover:border-purple-300 text-left transition-all shadow-sm hover:shadow-md md:col-span-2 lg:col-span-1">
                            <div className="font-bold text-purple-800 flex items-center gap-2 text-lg group-hover:text-purple-900">
                                <IconScan className="w-5 h-5"/> 5. 3D LiDAR
                            </div>
                            <div className="text-sm text-gray-600 mt-2">
                                Interactive 3D point cloud. Visualize how AI separates ground from vegetation.
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- LAB GUIDE MODAL ---
        const LabGuideModal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <IconBook className="text-green-700" /> {title}
                        </h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-red-500">
                            <IconX />
                        </button>
                    </div>
                    {children}
                </div>
            </div>
        );

        // --- MODULE 1: COMPUTER VISION SIMULATOR ---
        const VisionLab = () => {
            const canvasRef = useRef(null);
            const [threshold, setThreshold] = useState(50);
            const [stats, setStats] = useState({ logsFound: 0, falsePositives: 0, actualLogs: 0 });
            const [objects, setObjects] = useState([]);
            const [showGuide, setShowGuide] = useState(false);

            useEffect(() => {
                const newObjects = [];
                for(let i=0; i<15; i++) {
                    newObjects.push({
                        x: Math.random() * 500 + 50,
                        y: Math.random() * 300 + 50,
                        r: Math.random() * 15 + 10,
                        type: 'log',
                        score: Math.random() * 0.3 + 0.7 
                    });
                }
                for(let i=0; i<20; i++) {
                    newObjects.push({
                        x: Math.random() * 500 + 50,
                        y: Math.random() * 300 + 50,
                        r: Math.random() * 10 + 5,
                        type: 'rock',
                        score: Math.random() * 0.6 
                    });
                }
                setObjects(newObjects);
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0, 600, 400);

                ctx.fillStyle = '#3f3f3f'; 
                ctx.fillRect(0,0, 600, 400);

                let found = 0;
                let fps = 0;
                let actual = 0;

                objects.forEach(obj => {
                    if(obj.type === 'log') {
                        actual++;
                        ctx.beginPath();
                        ctx.arc(obj.x, obj.y, obj.r, 0, 2*Math.PI);
                        ctx.fillStyle = '#d4a373'; 
                        ctx.fill();
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.arc(obj.x, obj.y, obj.r*0.6, 0, 2*Math.PI);
                        ctx.strokeStyle = '#a98467';
                        ctx.stroke();
                    } else {
                        ctx.beginPath();
                        ctx.moveTo(obj.x, obj.y - obj.r);
                        ctx.lineTo(obj.x + obj.r, obj.y + obj.r);
                        ctx.lineTo(obj.x - obj.r, obj.y + obj.r);
                        ctx.closePath();
                        ctx.fillStyle = '#7f8c8d'; 
                        ctx.fill();
                    }

                    if(obj.score >= (threshold / 100)) {
                        ctx.strokeStyle = '#00ff00'; 
                        ctx.lineWidth = 2;
                        ctx.strokeRect(obj.x - obj.r - 2, obj.y - obj.r - 2, obj.r*2+4, obj.r*2+4);
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '10px monospace';
                        ctx.fillText(`LOG ${(obj.score*100).toFixed(0)}%`, obj.x - obj.r, obj.y - obj.r - 4);
                        if(obj.type === 'log') found++;
                        else fps++;
                    }
                });

                setStats({ logsFound: found, falsePositives: fps, actualLogs: actual });

            }, [threshold, objects]);

            return (
                <div className="flex flex-col gap-4">
                    {showGuide && (
                        <LabGuideModal title="Lab 1: The Digital Eye" onClose={() => setShowGuide(false)}>
                            <VisionGuideContent />
                        </LabGuideModal>
                    )}
                    
                    <div className="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-600">
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <IconEye className="text-green-600"/> Module 1: Computer Vision
                            </h3>
                            <button 
                                onClick={() => setShowGuide(true)}
                                className="bg-green-100 hover:bg-green-200 text-green-800 text-sm font-bold py-1 px-3 rounded flex items-center gap-2 transition-colors"
                            >
                                <IconBook className="w-4 h-4" /> Open Lab Guide
                            </button>
                        </div>
                        <p className="text-gray-600 text-sm mb-4">
                            Simulate a "Log Scaler" app. Adjust the <strong>Confidence Threshold</strong> to see how the AI decides what is a log.
                        </p>
                        
                        <div className="flex items-center gap-4 mb-4">
                            <label className="font-bold text-sm whitespace-nowrap">AI Confidence:</label>
                            <input 
                                type="range" 
                                min="1" max="99" 
                                value={threshold} 
                                onChange={(e) => setThreshold(e.target.value)}
                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                            />
                            <span className="w-12 text-center font-mono font-bold bg-gray-100 p-1 rounded">{threshold}%</span>
                        </div>

                        <div className="grid grid-cols-3 gap-2 text-center mb-2">
                            <div className="bg-blue-50 p-2 rounded">
                                <div className="text-xs text-blue-800">Actual Logs</div>
                                <div className="font-bold text-xl">{stats.actualLogs}</div>
                            </div>
                            <div className="bg-green-50 p-2 rounded">
                                <div className="text-xs text-green-800">Correctly ID'd</div>
                                <div className="font-bold text-xl">{stats.logsFound}</div>
                            </div>
                            <div className="bg-red-50 p-2 rounded">
                                <div className="text-xs text-red-800">False Positives</div>
                                <div className="font-bold text-xl text-red-600">{stats.falsePositives}</div>
                            </div>
                        </div>
                    </div>
                    <div className="flex justify-center bg-gray-900 rounded-lg p-2 shadow-inner overflow-hidden relative">
                        <div className="absolute top-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded pointer-events-none">
                            Live Feed
                        </div>
                        <canvas ref={canvasRef} width="600" height="400" className="w-full h-auto bg-gray-800 rounded"></canvas>
                    </div>
                </div>
            );
        };

        // --- MODULE 2: PREDICTIVE ANALYTICS SIMULATOR (ENHANCED) ---
        const PredictiveLab = () => {
            const GRID_SIZE = 30;
            // Cell: 0=Forest, 1=Grass, 2=Water, 3=Burnt, 4=Fire, 5=Break
            const [grid, setGrid] = useState([]);
            const [isRunning, setIsRunning] = useState(false);
            const [params, setParams] = useState({ windSpeed: 2, windDir: 'E', moisture: 15 });
            const [tool, setTool] = useState('break'); // 'break', 'ignite'
            const [stats, setStats] = useState({ burned: 0, containment: 0 });
            const [showGuide, setShowGuide] = useState(false);
            const simulationRef = useRef(null);

            // Initialize Map with Terrain
            const resetGrid = () => {
                const newGrid = [];
                for(let y=0; y<GRID_SIZE; y++) {
                    const row = [];
                    for(let x=0; x<GRID_SIZE; x++) {
                        // Generate terrain noise
                        const noise = Math.sin(x*0.2) + Math.cos(y*0.3);
                        let cell = { type: 0, state: 0 }; // 0:Forest
                        
                        if(noise > 1.2) cell.type = 2; // Water
                        else if(noise < -0.8) cell.type = 1; // Grass (Flashy fuel)
                        
                        row.push(cell);
                    }
                    newGrid.push(row);
                }
                // Initial ignition point center
                newGrid[Math.floor(GRID_SIZE/2)][Math.floor(GRID_SIZE/2)].state = 1; 
                setGrid(newGrid);
                setStats({ burned: 0, containment: 0 });
                setIsRunning(false);
                if(simulationRef.current) clearInterval(simulationRef.current);
            };

            useEffect(() => resetGrid(), []);

            const handleCellClick = (x, y) => {
                if(isRunning) return; // No editing while running for simplicity
                const newGrid = [...grid];
                const cell = newGrid[y][x];
                
                if(tool === 'break') {
                    // Toggle Dozer Line
                    if(cell.type === 5) cell.type = 0; // Remove break
                    else cell.type = 5; // Add break
                } else if(tool === 'ignite') {
                    cell.state = 1; // Ignite
                }
                setGrid(newGrid);
            };

            const step = () => {
                setGrid(prev => {
                    const next = prev.map(row => row.map(cell => ({...cell})));
                    let changed = false;
                    let burnCount = 0;

                    for(let y=0; y<GRID_SIZE; y++) {
                        for(let x=0; x<GRID_SIZE; x++) {
                            const cell = prev[y][x];
                            if(cell.state === 2) burnCount++; // Count burnt

                            if(cell.state === 1) {
                                // Cell is burning, turn to ash next turn
                                next[y][x].state = 2;
                                changed = true;
                                burnCount++;

                                // Spread to neighbors
                                const neighbors = [
                                    {dx:0, dy:-1, dir:'N'}, {dx:0, dy:1, dir:'S'}, 
                                    {dx:-1, dy:0, dir:'W'}, {dx:1, dy:0, dir:'E'}
                                ];

                                neighbors.forEach(n => {
                                    const ny = y + n.dy;
                                    const nx = x + n.dx;
                                    
                                    if(ny >= 0 && ny < GRID_SIZE && nx >= 0 && nx < GRID_SIZE) {
                                        const target = prev[ny][nx];
                                        if(target.state === 0 && target.type !== 2 && target.type !== 5) { // Not water, not break
                                            // Spread Probability Logic (The Fire Triangle)
                                            let prob = 0.15; // Base rate
                                            
                                            // 1. Fuel Modifier
                                            if(target.type === 1) prob += 0.25; // Grass burns fast
                                            
                                            // 2. Moisture Modifier
                                            prob -= (params.moisture / 100) * 0.2; 

                                            // 3. Wind Modifier
                                            if(params.windSpeed > 0) {
                                                if(params.windDir === n.dir) prob += (params.windSpeed * 0.08); // Pushing fire
                                                else if(params.windDir !== n.dir) prob -= 0.05; // Backing fire
                                            }

                                            if(Math.random() < prob) {
                                                next[ny][nx].state = 1;
                                                changed = true;
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                    setStats(s => ({ ...s, burned: burnCount }));
                    if(!changed) setIsRunning(false);
                    return next;
                });
            };

            useEffect(() => {
                if(isRunning) simulationRef.current = setInterval(step, 150);
                else clearInterval(simulationRef.current);
                return () => clearInterval(simulationRef.current);
            }, [isRunning, params]);

            const getCellClass = (cell) => {
                if(cell.state === 1) return 'burning';
                if(cell.state === 2) return 'bg-gray-800'; // Ash
                if(cell.type === 2) return 'bg-blue-400'; // Water
                if(cell.type === 5) return 'bg-yellow-700 border border-yellow-900'; // Dozer Line
                if(cell.type === 1) return 'bg-green-300'; // Grass
                return 'bg-green-700'; // Forest
            };

            return (
                <div className="flex flex-col md:flex-row gap-6">
                    {showGuide && (
                        <LabGuideModal title="Lab 2: The Crystal Ball" onClose={() => setShowGuide(false)}>
                            <PredictionGuideContent />
                        </LabGuideModal>
                    )}

                    <div className="flex-1 bg-white p-4 rounded-lg shadow-md border-l-4 border-red-600 space-y-6">
                        <div>
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    <IconFire className="text-red-600"/> Module 2: Prediction
                                </h3>
                                <button 
                                    onClick={() => setShowGuide(true)}
                                    className="bg-red-100 hover:bg-red-200 text-red-800 text-sm font-bold py-1 px-3 rounded flex items-center gap-2 transition-colors"
                                >
                                    <IconBook className="w-4 h-4" /> Open Lab Guide
                                </button>
                            </div>
                            <p className="text-sm text-gray-600">
                                <strong>Scenario:</strong> A fire has started in mixed terrain. As the Incident Commander, you must predict spread and dig containment lines.
                            </p>
                        </div>

                        {/* Fire Triangle Controls */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h4 className="font-bold text-xs uppercase text-gray-500 tracking-wider border-b pb-1">Environmental Inputs</h4>
                            
                            <div>
                                <label className="text-xs font-bold flex justify-between">
                                    <span>Wind Direction</span> 
                                    <span className="text-red-600">{params.windDir}</span>
                                </label>
                                <div className="flex gap-1 mt-1">
                                    {['N','S','E','W'].map(d => (
                                        <button key={d} onClick={()=>setParams({...params, windDir:d})} 
                                            className={`flex-1 py-1 text-xs font-bold rounded ${params.windDir===d ? 'bg-red-600 text-white' : 'bg-gray-200'}`}>
                                            {d}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="text-xs font-bold block">Wind Speed: {params.windSpeed}</label>
                                    <input type="range" min="0" max="10" value={params.windSpeed} onChange={e=>setParams({...params, windSpeed: parseInt(e.target.value)})} className="w-full h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer mt-1"/>
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs font-bold block">Fuel Moisture: {params.moisture}%</label>
                                    <input type="range" min="0" max="50" value={params.moisture} onChange={e=>setParams({...params, moisture: parseInt(e.target.value)})} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer mt-1"/>
                                </div>
                            </div>
                        </div>

                        {/* Interactive Tools */}
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 space-y-3">
                            <h4 className="font-bold text-xs uppercase text-yellow-800 tracking-wider border-b border-yellow-200 pb-1">Response Tactics</h4>
                            <div className="flex gap-2">
                                <button onClick={() => setTool('break')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded font-bold text-sm border-2 ${tool==='break' ? 'border-yellow-700 bg-yellow-100 text-yellow-900' : 'border-transparent bg-white text-gray-600 hover:bg-yellow-50'}`}>
                                    <IconShovel className="w-4 h-4"/> Dozer Line
                                </button>
                                <button onClick={() => setTool('ignite')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded font-bold text-sm border-2 ${tool==='ignite' ? 'border-red-500 bg-red-50 text-red-900' : 'border-transparent bg-white text-gray-600 hover:bg-red-50'}`}>
                                    <IconFire className="w-4 h-4"/> Ignite
                                </button>
                            </div>
                            <p className="text-xs text-yellow-800 italic">
                                *Click on the map to use the selected tool. Build firebreaks to stop the spread.
                            </p>
                        </div>

                        {/* Action Buttons */}
                        <div className="flex gap-2 pt-2">
                            <button onClick={() => setIsRunning(!isRunning)} className={`flex-1 py-3 rounded-lg font-bold text-white shadow-md transition-all active:scale-95 ${isRunning ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-700 hover:bg-green-800'}`}>
                                {isRunning ? 'PAUSE OPERATION' : 'START SIMULATION'}
                            </button>
                            <button onClick={resetGrid} className="px-4 py-3 border border-gray-300 bg-white rounded-lg hover:bg-gray-100 font-bold text-gray-600">
                                Reset
                            </button>
                        </div>

                        {/* Metrics */}
                        <div className="flex justify-between items-center text-sm font-mono bg-gray-100 p-2 rounded">
                            <span>Burned Cells: {stats.burned}</span>
                            <span className={isRunning ? "text-red-500 font-bold animate-pulse" : "text-gray-500"}>
                                {isRunning ? "LIVE" : "PAUSED"}
                            </span>
                        </div>
                    </div>

                    {/* Map Visualization */}
                    <div className="bg-gray-900 p-2 rounded-lg shadow-2xl border-4 border-gray-800 flex-1 relative">
                        <div className="absolute top-4 left-4 bg-black/60 text-white text-[10px] p-2 rounded pointer-events-none z-10 space-y-1 backdrop-blur-sm">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-700 rounded-sm"></div> Timber (Slow)</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-300 rounded-sm"></div> Grass (Fast)</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-400 rounded-sm"></div> Water (Barrier)</div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 bg-yellow-700 rounded-sm border border-yellow-500"></div> Dozer Line</div>
                        </div>
                        
                        <div className="grid gap-px bg-gray-900 h-full w-full aspect-square" style={{ gridTemplateColumns: `repeat(${GRID_SIZE}, minmax(0, 1fr))` }}>
                            {grid.map((row, y) => (
                                row.map((cell, x) => (
                                    <div 
                                        key={`${x}-${y}`} 
                                        onMouseDown={() => handleCellClick(x, y)}
                                        onMouseEnter={(e) => { if(e.buttons === 1) handleCellClick(x,y); }}
                                        className={`w-full h-full cursor-pointer transition-colors duration-200 ${getCellClass(cell)}`}
                                    ></div>
                                ))
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODULE 3: GENERATIVE AI SIMULATOR ---
        const GenAILab = () => {
            const [input, setInput] = useState("Block 42 survey complete. Found good stocking, approx 400 stems/ha. Mostly Douglas Fir. Some minor blowdown on the west edge. Access road needs grading.");
            const [output, setOutput] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [showTruth, setShowTruth] = useState(false);

            const generateReport = () => {
                setIsGenerating(true);
                setOutput("");
                setShowTruth(false);
                
                setTimeout(() => {
                    const cleanText = `SURVEY REPORT: BLOCK 42\n\nDATE: ${new Date().toLocaleDateString()}\n\nOVERVIEW:\nThe stocking survey for Block 42 indicates a healthy regeneration status with approximately 400 stems per hectare (sph), predominantly composed of Douglas Fir. \n\nFOREST HEALTH:\nNo significant pest or disease issues were noted. `;
                    
                    // The Hallucination
                    const hallucination = `However, a nesting pair of Marbled Murrelets (endangered) was observed in the old-growth patch near the creek. `;
                    
                    const endText = `\n\nOPERATIONAL NOTES:\nMinor blowdown was observed along the western boundary. The primary access road requires grading to ensure safe vehicle passage for future operations.`;

                    setOutput({ prefix: cleanText, lie: hallucination, suffix: endText });
                    setIsGenerating(false);
                }, 1500);
            };

            return (
                <div className="grid md:grid-cols-2 gap-6 h-full">
                    <div className="flex flex-col gap-2">
                        <label className="font-bold text-sm text-gray-700">1. Messy Field Notes (Input)</label>
                        <textarea 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            className="w-full h-40 p-3 border rounded-lg font-mono text-sm shadow-inner focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                        <button 
                            onClick={generateReport}
                            disabled={isGenerating}
                            className="bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition disabled:opacity-50 flex justify-center items-center gap-2"
                        >
                            {isGenerating ? <span><span className="animate-spin">âŸ³</span> AI is Thinking...</span> : "Generate Professional Report"}
                        </button>
                    </div>

                    <div className="flex flex-col gap-2">
                        <label className="font-bold text-sm text-gray-700 flex justify-between">
                            <span>2. AI Output</span>
                            {output && (
                                <button onClick={() => setShowTruth(!showTruth)} className="text-xs font-bold text-blue-600 hover:underline">
                                    {showTruth ? "Hide Validation" : "Verify Data"}
                                </button>
                            )}
                        </label>
                        <div className="w-full h-full min-h-[200px] p-4 bg-white border rounded-lg shadow-sm whitespace-pre-wrap text-sm leading-relaxed font-serif text-gray-800">
                            {!output && <span className="text-gray-400 italic font-sans">Output will appear here...</span>}
                            {output && (
                                <React.Fragment>
                                    {output.prefix}
                                    <span className={`transition-colors duration-500 ${showTruth ? 'bg-red-100 text-red-800 font-bold px-1 rounded border border-red-200' : ''}`}>
                                        {output.lie}
                                    </span>
                                    {output.suffix}
                                </React.Fragment>
                            )}
                        </div>
                        {showTruth && (
                            <div className="bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-200 flex gap-2 items-start">
                                <span className="text-lg">âš ï¸</span>
                                <div>
                                    <strong>Hallucination Detected:</strong> The AI invented the "Marbled Murrelet" sighting. This was not in your original notes! 
                                    <br/><em>Lesson: Always verify AI outputs against your ground truth data.</em>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MODULE 4: GARBAGE IN, GARBAGE OUT (DATA LAB) ---
        const DataLab = () => {
            const [stage, setStage] = useState('train'); // train, test, result
            const [trainingSet, setTrainingSet] = useState([]);
            const [modelQuality, setModelQuality] = useState(0); // 0 to 100
            
            // Training Images
            const samples = [
                { id: 1, type: 'tree', label: 'Healthy Fir', icon: 'ðŸŒ²', correct: true },
                { id: 2, type: 'tree', label: 'Spruce', icon: 'ðŸŒ²', correct: true },
                { id: 3, type: 'pole', label: 'Telephone Pole', icon: 'T', correct: false },
                { id: 4, type: 'snag', label: 'Dead Snag', icon: 'ðŸ’€', correct: false },
                { id: 5, type: 'tree', label: 'Pine', icon: 'ðŸŒ²', correct: true },
            ];

            const toggleTrain = (id) => {
                if(trainingSet.includes(id)) setTrainingSet(trainingSet.filter(i => i !== id));
                else setTrainingSet([...trainingSet, id]);
            };

            const runTraining = () => {
                let score = 0;
                let treesSelected = 0;
                let trashSelected = 0;

                trainingSet.forEach(id => {
                    const sample = samples.find(s => s.id === id);
                    if(sample.correct) { score += 20; treesSelected++; }
                    else { score -= 30; trashSelected++; }
                });

                if(treesSelected < 3) score -= 20;
                if(score < 0) score = 0;
                if(score > 100) score = 100;

                setModelQuality(score);
                setStage('result');
            };

            return (
                <div className="max-w-2xl mx-auto">
                    {stage === 'train' && (
                        <div className="text-center">
                            <h3 className="font-bold text-lg mb-2">Train Your Drone AI</h3>
                            <p className="mb-4 text-sm text-gray-600">Select ONLY the <strong>Live Merchantable Trees</strong> to train the model. <br/>If you select garbage, the model will learn garbage.</p>
                            
                            <div className="flex justify-center gap-4 mb-6">
                                {samples.map(s => (
                                    <div 
                                        key={s.id} 
                                        onClick={() => toggleTrain(s.id)}
                                        className={`w-24 h-32 border-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-all ${trainingSet.includes(s.id) ? 'border-blue-500 bg-blue-50 ring-4 ring-blue-200 shadow-lg scale-105' : 'border-gray-200 hover:border-gray-400 hover:bg-gray-50'}`}
                                    >
                                        <div className="text-4xl">{s.icon}</div>
                                        <div className="text-xs font-bold text-gray-600">{s.label}</div>
                                    </div>
                                ))}
                            </div>

                            <button onClick={runTraining} className="bg-green-600 text-white px-8 py-3 rounded-full font-bold hover:bg-green-700 shadow-lg transform transition active:scale-95">
                                Train Model
                            </button>
                        </div>
                    )}

                    {stage === 'result' && (
                        <div className="bg-white p-6 rounded-lg border text-center shadow-lg">
                            <h3 className="text-xl font-bold mb-4">Model Performance</h3>
                            
                            <div className="mb-4">
                                <div className="text-sm text-gray-500 mb-1">Accuracy Score</div>
                                <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div 
                                        className={`h-4 rounded-full transition-all duration-1000 ${modelQuality > 80 ? 'bg-green-500' : modelQuality > 40 ? 'bg-yellow-500' : 'bg-red-500'}`} 
                                        style={{ width: `${modelQuality}%` }}
                                    ></div>
                                </div>
                                <div className="mt-2 font-bold text-2xl">{modelQuality}%</div>
                            </div>

                            <div className="mb-6 text-left bg-gray-50 p-4 rounded text-sm">
                                {modelQuality > 80 ? (
                                    <p className="text-green-700"><strong>Success!</strong> You fed the AI high-quality data. It can now distinguish between a tree and a telephone pole in the field.</p>
                                ) : modelQuality > 40 ? (
                                    <p className="text-yellow-700"><strong>Mediocre.</strong> You missed some trees or included some garbage. The AI will struggle in the field.</p>
                                ) : (
                                    <p className="text-red-700"><strong>Failure (GIGO).</strong> You trained the AI on garbage (poles/snags). It will now classify every telephone pole as a merchantable log. This is a liability nightmare.</p>
                                )}
                            </div>

                            <button onClick={() => {setStage('train'); setTrainingSet([]);}} className="text-blue-600 underline">Try Again</button>
                        </div>
                    )}
                </div>
            );
        };

        // --- MODULE 5: 3D LiDAR POINT CLOUD (THREE.JS) ---
        const LidarLab = () => {
            const mountRef = useRef(null);
            const pointsRef = useRef(null);
            const [mode, setMode] = useState('raw'); // raw, classified
            const [elevationFilter, setElevationFilter] = useState(0);

            // Re-bind the scene logic to capture the ref
            useEffect(() => {
                if(!mountRef.current) return;
                
                const mount = mountRef.current;
                
                // Clear previous contents if any
                while(mount.firstChild) {
                    mount.removeChild(mount.firstChild);
                }

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x111827);
                const camera = new THREE.PerspectiveCamera(60, mount.clientWidth / mount.clientHeight, 0.1, 1000);
                camera.position.set(0, 15, 30);
                camera.lookAt(0, 0, 0);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(mount.clientWidth, mount.clientHeight);
                mount.appendChild(renderer.domElement);

                // Data Gen
                const positions = [];
                const types = []; // 0=ground, 1=tree
                
                // Ground
                for(let i=0; i<4000; i++) {
                    const x = (Math.random()-0.5)*60;
                    const z = (Math.random()-0.5)*60;
                    const y = Math.sin(x*0.1)*2 + Math.cos(z*0.1)*2; // Terrain
                    positions.push(x,y,z);
                    types.push(0);
                }
                // Trees
                for(let t=0; t<20; t++) {
                    const tx = (Math.random()-0.5)*50;
                    const tz = (Math.random()-0.5)*50;
                    const baseH = Math.sin(tx*0.1)*2 + Math.cos(tz*0.1)*2;
                    // Trunk
                    for(let h=0; h<8; h+=0.3) {
                        positions.push(tx + (Math.random()-0.5)*0.3, baseH + h, tz + (Math.random()-0.5)*0.3);
                        types.push(1);
                    }
                    // Leaves
                    for(let l=0; l<40; l++) {
                        positions.push(
                            tx + (Math.random()-0.5)*5,
                            baseH + 5 + Math.random()*5,
                            tz + (Math.random()-0.5)*5
                        );
                        types.push(1);
                    }
                }

                const geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                
                // Init Colors
                const colors = new Float32Array(positions.length * 3); // 3 values per point
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                const material = new THREE.PointsMaterial({ size: 0.25, vertexColors: true });
                const pointCloud = new THREE.Points(geometry, material);
                scene.add(pointCloud);
                
                // Store refs for update loop
                pointsRef.current = { geometry, types, positions };

                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    pointCloud.rotation.y += 0.001;
                    renderer.render(scene, camera);
                };
                animate();

                // Store renderer to clean up later
                const currentMount = mount;
                const currentRenderer = renderer;

                return () => {
                    cancelAnimationFrame(frameId);
                    if(currentMount && currentRenderer.domElement) {
                        currentMount.removeChild(currentRenderer.domElement);
                    }
                    geometry.dispose();
                    material.dispose();
                };
            }, []);

            // Effect to Update Colors based on State
            useEffect(() => {
                if(!pointsRef.current) return;
                
                const { geometry, types, positions } = pointsRef.current;
                const colors = geometry.attributes.color.array;
                const pos = positions; // [x,y,z, x,y,z...]

                for(let i=0; i < types.length; i++) {
                    const y = pos[i*3 + 1]; // y coordinate
                    const isTree = types[i] === 1;
                    
                    // Filter Logic: If point is below filter height, hide it (make black/transparent)
                    // Note: ThreeJS points don't support transparency easily without sorting, so we'll just color them background color
                    if (y < elevationFilter) {
                        colors[i*3] = 0.07; // R (Dark Grey)
                        colors[i*3+1] = 0.09; // G
                        colors[i*3+2] = 0.15; // B
                    } else {
                        if (mode === 'raw') {
                            // White/Grey
                            colors[i*3] = 0.8;
                            colors[i*3+1] = 0.8;
                            colors[i*3+2] = 0.8;
                        } else {
                            // Classified
                            if (isTree) {
                                colors[i*3] = 0.2; // R
                                colors[i*3+1] = 0.8; // G (Green)
                                colors[i*3+2] = 0.2; // B
                            } else {
                                colors[i*3] = 0.6; // R (Brownish)
                                colors[i*3+1] = 0.4; // G
                                colors[i*3+2] = 0.2; // B
                            }
                        }
                    }
                }
                geometry.attributes.color.needsUpdate = true;

            }, [mode, elevationFilter]);

            return (
                <div className="flex flex-col gap-4">
                    <div className="bg-white p-4 rounded-lg shadow-md border-l-4 border-purple-600">
                        <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                            <IconScan className="text-purple-600"/> Module 5: LiDAR 3D Scanning (WebGL)
                        </h3>
                        <p className="text-gray-600 text-sm mb-4">
                            Simulate processing a LiDAR point cloud. Raw data is just "points in space." 
                            AI performs <strong>Semantic Segmentation</strong> to classify Ground vs. Vegetation.
                        </p>
                        
                        <div className="flex flex-wrap gap-4 items-center">
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setMode('raw')}
                                    className={`px-4 py-2 text-sm font-bold rounded ${mode==='raw' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'}`}
                                >
                                    Raw Data
                                </button>
                                <button 
                                    onClick={() => setMode('classified')}
                                    className={`px-4 py-2 text-sm font-bold rounded ${mode==='classified' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                                >
                                    Run AI Classification
                                </button>
                            </div>

                            <div className="flex-1 flex items-center gap-2 border-l pl-4 border-gray-300">
                                <label className="text-xs font-bold whitespace-nowrap">Filter Elevation:</label>
                                <input 
                                    type="range" min="-5" max="15" 
                                    value={elevationFilter} 
                                    onChange={e=>setElevationFilter(parseFloat(e.target.value))}
                                    className="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="relative h-[400px] w-full rounded-lg overflow-hidden shadow-2xl border-4 border-gray-800">
                        <div ref={mountRef} className="w-full h-full bg-gray-900" />
                        <div className="absolute bottom-2 left-2 text-gray-500 text-xs pointer-events-none">
                            Renderer: Three.js (WebGL) | Points: ~5000
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP SHELL ---
        const App = () => {
            const [activeTab, setActiveTab] = useState(0);

            const tabs = [
                { id: 0, title: "Home", component: <IntroLab setTab={setActiveTab} /> },
                { id: 1, title: "1. Vision", component: <VisionLab /> },
                { id: 2, title: "2. Prediction", component: <PredictiveLab /> },
                { id: 3, title: "3. GenAI", component: <GenAILab /> },
                { id: 4, title: "4. Data Quality", component: <DataLab /> },
                { id: 5, title: "5. LiDAR", component: <LidarLab /> },
            ];

            return (
                <div className="min-h-screen bg-gray-50 pb-10">
                    <div className="bg-green-900 text-white p-6 shadow-lg">
                        <div className="max-w-5xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-3">
                                    <IconTree className="text-green-300" /> Forestry AI Literacy Course
                                </h1>
                                <p className="text-green-200 opacity-80 mt-1 text-sm">Interactive Learning Labs v2.1</p>
                            </div>
                            <button onClick={() => setActiveTab(0)} className="text-sm bg-green-800 hover:bg-green-700 px-3 py-1 rounded border border-green-600 transition-colors hidden sm:block">
                                Back to Home
                            </button>
                        </div>
                    </div>

                    <div className="max-w-5xl mx-auto mt-6 px-4">
                        {/* Navigation */}
                        <div className="flex flex-wrap gap-2 mb-6 border-b border-gray-200 pb-1 overflow-x-auto">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`px-4 py-2 rounded-t-lg font-bold text-sm transition-all whitespace-nowrap ${
                                        activeTab === tab.id 
                                        ? 'bg-white text-green-900 border-t-4 border-green-600 shadow-sm translate-y-px' 
                                        : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                    }`}
                                >
                                    {tab.title}
                                </button>
                            ))}
                        </div>

                        {/* Content Area */}
                        <div className="bg-white p-6 rounded-b-lg rounded-r-lg shadow-sm min-h-[500px]">
                            {tabs[activeTab].component}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>